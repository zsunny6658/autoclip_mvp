# LLM调试日志增强功能说明

## 概述

为了更好地排查LLM调用过程中的问题，特别是"返回结果中缺少内容导致无法完成视频生成"的问题，我们对项目中的LLM调用增加了详细的调试日志。

## 增强内容

### 1. LLM客户端层面的日志增强

#### 1.1 通义千问客户端 (`src/utils/llm_client.py`)

**调用开始日志：**
- 🚀 [LLM调用开始] 模型信息
- 📝 [提示词长度] 字符统计
- 📊 [输入数据] 类型和大小统计
- 🔢 [完整输入长度] 总字符数
- 📄 [完整输入内容前500字符] 内容预览（DEBUG级别）

**API调用过程日志：**
- ⏱️ [API调用] 开始时间和耗时统计
- 📥 [API响应] 状态码信息

**调用成功日志：**
- ✅ [API调用成功] 响应长度和结束原因
- 📄 [响应内容前500字符] 内容预览（DEBUG级别）
- ⚠️ [响应质量警告] 响应过短警告
- 🔍 [响应格式] JSON格式检测

**错误处理日志：**
- ❌ [API调用失败] 详细错误信息
- 🔑 [API Key错误] 特定错误提示
- ❌ [LLM调用异常] 异常类型和详情
- 📄 [调用上下文] 模型和输入长度信息

**重试机制日志：**
- 🔄 [重试机制] 开始重试，显示最大重试次数
- 🔢 [第X次尝试] 每次尝试的开始
- ✅ [第X次尝试成功] 成功完成
- ⚠️ [第X次失败] 失败详情和错误类型
- ⏳ [等待重试] 等待时间和下次尝试信息
- ❌ [重试失败] 最终失败信息

#### 1.2 硅基流动客户端 (`src/utils/siliconflow_client.py`)

提供与通义千问客户端相同级别的详细日志，但标识为"SiliconFlow"相关。

### 2. JSON解析层面的日志增强

#### 2.1 解析过程日志

**解析开始：**
- 🔍 [JSON解析开始] 原始响应统计
- 📄 [原始响应前300字符] 内容预览

**预处理阶段：**
- 🧹 [预处理完成] 处理后长度统计
- 📄 [预处理后内容前200字符] 内容预览

**阶段性解析：**
- 🔍 [阶段1] 尝试从Markdown代码块提取JSON
- ✅ [Markdown提取成功] 提取的JSON长度
- ❌ [JSON解析失败] 具体错误位置和上下文
- 🔧 [尝试修复] JSON格式修复
- 🔍 [阶段2] 尝试直接解析整个响应
- 🔍 [阶段3] 使用正则表达式查找JSON
- ✅ [正则匹配成功] 找到的JSON结构
- 🔧 [最后尝试] 修复后再次解析

**最终结果：**
- ✅ [最终成功] 成功的解析阶段
- ❌ [彻底失败] 所有解析方法都失败
- 💾 [调试信息] 原始响应保存路径

### 3. Pipeline步骤层面的日志增强

#### 3.1 Step2 时间轴提取 (`src/pipeline/step2_timeline.py`)

- 🚀 [块X第Y次尝试] LLM调用开始
- 📊 [输入统计] 大纲数量和SRT条目统计
- 📄 [输入详情] SRT文本预览
- ✅ [块X响应成功] 获得响应统计
- 💾 [缓存保存] 原始响应保存路径
- 🔍 [块X开始解析] 解析JSON数据
- ✅ [块X解析成功] 解析出的时间轴项目数量
- ⚠️ [块X解析失败] 解析失败信息

#### 3.2 Step3 内容评分 (`src/pipeline/step3_scoring.py`)

- ✅ [评分响应成功] 获得LLM响应统计
- 📄 [评分响应内容] 响应内容预览
- 🔍 [开始解析] 解析LLM评分响应
- ❌ [评分结果错误] 数量不匹配详情
- 📄 [评分解析结果类型] 结果类型和预览

#### 3.3 Step4 标题生成 (`src/pipeline/step4_title.py`)

- 🚀 [块X标题生成] 开始调用LLM生成标题
- 📊 [输入统计] 块包含的片段数量
- 📄 [输入详情] 前3个片段预览
- ✅ [块X响应成功] 获得LLM响应统计
- 💾 [LLM原始响应已保存到] 保存路径
- 🔍 [开始解析] 解析标题生成响应

#### 3.4 Step5 主题聚类 (`src/pipeline/step5_clustering.py`)

- 🚀 [聚类开始] 调用LLM进行主题聚类
- 📄 [提示词长度] 字符统计
- 📄 [提示词预览] 内容预览
- ✅ [聚类响应成功] 获得LLM响应统计
- 🔍 [开始解析] 解析LLM聚类响应

## 使用方法

### 1. 设置日志级别

为了看到完整的调试信息，建议设置日志级别为DEBUG：

```python
import logging
logging.basicConfig(level=logging.DEBUG)
```

### 2. 运行测试

使用提供的测试脚本验证日志功能：

```bash
cd autoclip_mvp
python test_llm_debug_logs.py
```

### 3. 查看日志文件

程序运行时会自动保存以下调试文件：

- **LLM原始响应缓存**：`metadata/stepX_llm_raw_output/`
- **调试响应文件**：`metadata/debug_responses/`
- **临时解析失败文件**：自动生成的临时文件

## 故障排查指南

### 1. "返回结果中缺少内容"问题

**查看关键日志：**
1. 🚀 [LLM调用开始] - 确认输入数据是否正确
2. ✅ [API调用成功] - 确认API调用成功且有响应
3. ⚠️ [响应质量警告] - 检查是否有响应过短警告
4. 🔍 [JSON解析开始] - 查看解析过程
5. ❌ [解析失败] - 查看具体失败原因

**常见原因和解决方案：**

- **响应被截断**：查看API响应长度，可能触发了长度限制
- **JSON格式错误**：查看解析阶段日志，检查JSON格式问题
- **内容安全过滤**：查看API结束原因，可能被内容安全策略过滤
- **模型理解错误**：查看输入统计，检查提示词和输入数据是否合理

### 2. API调用失败问题

**查看关键日志：**
1. 🔑 [API Key错误] - 检查API密钥配置
2. ❌ [API调用失败] - 查看具体错误码和消息
3. 🔄 [重试机制] - 查看重试过程
4. ❌ [重试失败] - 查看最终失败原因

### 3. 性能问题

**查看关键日志：**
1. ⏱️ [API调用] - 查看每次调用的耗时
2. 📊 [输入统计] - 检查输入数据大小是否合理
3. 🔄 [重试机制] - 查看是否频繁重试

## 注意事项

1. **日志级别**：DEBUG级别会显示输入输出内容预览，可能包含敏感信息
2. **文件存储**：调试文件会保存到磁盘，注意定期清理
3. **性能影响**：详细日志会轻微影响性能，生产环境可考虑调整为INFO级别
4. **日志大小**：大量调用会产生大量日志，注意日志文件大小管理

## 示例日志输出

```
2024-01-20 10:30:15 - 🚀 [LLM调用开始] 模型: qwen-max
2024-01-20 10:30:15 - 📝 [提示词长度]: 1250 字符
2024-01-20 10:30:15 - 📊 [输入数据]: 类型=dict, 大小=3420 字符
2024-01-20 10:30:15 - 🔢 [完整输入长度]: 4670 字符
2024-01-20 10:30:15 - ⏱️ [API调用] 开始时间: 2024-01-20 10:30:15
2024-01-20 10:30:18 - ⏱️ [API调用] 耗时: 2.85 秒
2024-01-20 10:30:18 - ✅ [API调用成功] 响应长度: 1584 字符
2024-01-20 10:30:18 - 🎯 [结束原因]: stop
2024-01-20 10:30:18 - 🔍 [响应格式] 检测到JSON格式内容
2024-01-20 10:30:18 - 🔍 [JSON解析开始] 原始响应长度: 1584 字符
2024-01-20 10:30:18 - 🧹 [预处理完成] 处理后长度: 1520 字符
2024-01-20 10:30:18 - 🔍 [阶段1] 尝试从Markdown代码块提取JSON...
2024-01-20 10:30:18 - ✅ [Markdown提取成功] JSON字符串长度: 1456
2024-01-20 10:30:18 - ✅ [阶段1成功] Markdown提取并解析JSON成功
```